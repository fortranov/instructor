# Руководство по развертыванию на продакшене

## Проблема
Тренировки по триатлону распределяются по всем дням недели, включая среду, независимо от настроек предпочтительных дней пользователя.

## Решение
Исправления уже внесены в код. Для решения проблемы на продакшене необходимо выполнить следующие шаги:

### 1. Развертывание новой версии кода
```bash
# Обновить код из репозитория
git pull origin main

# Пересобрать Docker контейнеры
sudo docker-compose down
sudo docker-compose build
sudo docker-compose up -d
```

### 2. Выполнение миграций
**Примечание**: Миграции выполняются автоматически при запуске сервиса `migrations` в `docker-compose up -d`.

Если нужно выполнить миграции вручную:
```bash
# Выполнить миграции для обновления настроек пользователей
sudo docker-compose exec backend python run_migrations.py migrate
```

### 3. Проверка миграций
```bash
# Проверить статус миграций
sudo docker-compose exec backend python run_migrations.py status
```

### 4. Проверка настроек пользователей
```bash
# Проверить настройки пользователей (если файл существует)
sudo docker-compose exec backend python check_user_settings.py
```

## Что исправлено

### 1. Значения по умолчанию
- **Было**: `[0,1,2,3,4,5,6]` (включая среду)
- **Стало**: `[0,1,4,5,6]` (исключая среду)

### 2. Миграции
- **001**: Добавление поля `preferred_workout_days`
- **002**: Исправление исключения среды (обновление на `[0,1,2,3,4,5,6]`)
- **003**: Правильное исправление исключения среды (обновление на `[0,1,4,5,6]`)

### 3. Логика фильтрации
- Убрана логика переноса тренировок на ближайший предпочтительный день
- Теперь тренировки просто исключаются, если они не в предпочтительных днях

## Проверка работы

### 1. Создание нового пользователя
Новый пользователь должен получить настройки по умолчанию `[0,1,4,5,6]` (без среды).

### 2. Обновление настроек существующего пользователя
При изменении предпочтительных дней в настройках профиля, эти изменения должны отражаться на распределении тренировок.

### 3. Создание плана тренировок
Тренировки должны распределяться только по предпочтительным дням пользователя.

## Возможные проблемы

### 1. Старая версия кода
Если на продакшене развернута старая версия кода, миграции могут не работать корректно.

### 2. Проблемы с миграциями
Если миграции не выполняются, пользователи могут остаться со старыми настройками.

### 3. Кэширование
Если есть кэширование на уровне приложения, изменения могут не применяться сразу.

## Откат изменений
Если что-то пойдет не так, можно откатить миграции:

```bash
# Откатить последнюю миграцию
sudo docker-compose exec backend python run_migrations.py rollback 003_fix_wednesday_exclusion_correct
```

## Контакты
При возникновении проблем обратитесь к разработчику.
